version: "3.7"

networks:
  n3:
    driver: bridge
  n4:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.230.0.0/24
  n6:
    external: true
  n7:
    driver: bridge
  n8:
    driver: bridge
  n10:
    driver: bridge
  n11:
    driver: bridge
  n12:
    driver: bridge
  n13:
    driver: bridge
  n15:
    driver: bridge
  default:
    driver: bridge

services:
  mongodb:
    networks:
      - default
    image: mongo:4.2
    container_name: free5gc-mongodb
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
  
  amf:
    networks:
      - default
      - n11
      - n12
      - n15
    image: free5gc-v2
    container_name: free5gc-amf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./amf

  smf:
    networks:
      default:
      n7:
      n11:
      n10:
      n4:
        ipv4_address: 172.230.0.100 
    image: free5gc-v2
    container_name: free5gc-smf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    volumes:
      - ./config/smfcfg.conf:/root/free5gc/config/smfcfg.conf
    entrypoint:
      - ./smf

  pcf:
    networks:
      - default
      - n7
      - n15
    image: free5gc-v2
    container_name: free5gc-pcf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./pcf

  ausf:
    networks:
      - default
      - n8
      - n12
      - n13
    image: free5gc-v2
    container_name: free5gc-ausf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./ausf

  nrf:
    networks:
      - default
    image: free5gc-v2
    container_name: free5gc-nrf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    volumes:
      - ./support/TLS/nrf.pem:/root/free5gc/support/TLS/nrf.pem
      - ./support/TLS/nrf.key:/root/free5gc/support/TLS/nrf.key
    entrypoint:
      - ./nrf

  nssf:
    networks:
      - default
    image: free5gc-v2
    container_name: free5gc-nssf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./nssf

  udm:
    networks:
      - default
      - n13
      - n10
      - n8
    image: free5gc-v2
    container_name: free5gc-udm
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./udm

  udr:
    networks:
      - default
    image: free5gc-v2
    container_name: free5gc-udr
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    entrypoint:
      - ./udr

  upf:
    networks:
      n6:
      n3:
      n4:
        ipv4_address: 172.230.0.110 
    image: free5gc-v2
    container_name: free5gc-upf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    volumes:
      - ./config/upfcfg.yaml:/root/free5gc/config/upfcfg.yaml
    entrypoint:
      - ./free5gc-upfd
